{% extends 'base.html' %}
{% load static %}

{% block title %}Create User - ArmGuard{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-container h1 {
        margin-top: 0;
        color: #333;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .form-section:last-of-type {
        border-bottom: none;
    }
    
    .form-section h2 {
        font-size: 1.25rem;
        color: #374151;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 500;
    }
    
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="file"],
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-primary:hover {
        background: #5568d3;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    .errorlist {
        list-style: none;
        padding: 0;
        color: #dc2626;
        font-size: 0.875rem;
    }
    
    .hidden {
        display: none;
    }
    
    .role-notice {
        background: #f3f4f6;
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container" data-is-edit="{% if is_edit %}true{% else %}false{% endif %}">
    <h1>{% if is_edit %}Edit User{% else %}Register User{% endif %}</h1>
    <p style="color: #666; margin-bottom: 1.5rem;">
        {% if is_edit %}
        Update user information and personnel profile.
        {% else %}
        Select role and fill in the required information.
        {% endif %}
    </p>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-section">
            <h2>Role Selection</h2>
            
            <div class="form-group">
                {{ form.role.errors }}
                <label for="{{ form.role.id_for_label }}">{{ form.role.label }} *</label>
                {{ form.role }}
            </div>
            
            <div id="roleNotice" class="role-notice hidden">
                <strong id="roleNoticeText"></strong>
            </div>
        </div>
        
        <div class="form-section" id="accountSection">
            <h2>Account Information</h2>
            
            {% if is_edit %}
            <div class="form-group">
                {{ form.existing_personnel.errors }}
                <label for="{{ form.existing_personnel.id_for_label }}">{{ form.existing_personnel.label }}</label>
                {{ form.existing_personnel }}
                {% if form.existing_personnel.help_text %}
                <p class="help-text">{{ form.existing_personnel.help_text }}</p>
                {% endif %}
                {% if personnel %}
                <p class="help-text" style="color: #059669;">Currently linked to: <strong>{{ personnel.get_full_name }} ({{ personnel.id }})</strong></p>
                {% else %}
                <p class="help-text" style="color: #dc2626;">No personnel linked. Select one above or fill in personnel details below.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="form-group" id="usernameGroup">
                {{ form.username.errors }}
                <label for="{{ form.username.id_for_label }}">{{ form.username.label }} *</label>
                {{ form.username }}
            </div>
            
            <div class="form-group" id="emailGroup">
                {{ form.email.errors }}
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }} *</label>
                {{ form.email }}
            </div>
            
            <div class="form-group" id="passwordGroup">
                {{ form.password.errors }}
                <label for="{{ form.password.id_for_label }}">{{ form.password.label }} {% if not is_edit %}*{% endif %}</label>
                {{ form.password }}
                {% if is_edit %}
                <p class="help-text">Leave blank to keep current password</p>
                {% endif %}
            </div>
            
            <div class="form-group" id="confirmPasswordGroup">
                {{ form.confirm_password.errors }}
                <label for="{{ form.confirm_password.id_for_label }}">{{ form.confirm_password.label }} {% if not is_edit %}*{% endif %}</label>
                {{ form.confirm_password }}
                {% if is_edit %}
                <p class="help-text">Leave blank to keep current password</p>
                {% endif %}
            </div>
        </div>
        
        <div class="form-section">
            <h2>Personnel Information</h2>
            
            <div class="form-group">
                {{ form.surname.errors }}
                <label for="{{ form.surname.id_for_label }}">{{ form.surname.label }} *</label>
                {{ form.surname }}
            </div>
            
            <div class="form-group">
                {{ form.firstname.errors }}
                <label for="{{ form.firstname.id_for_label }}">{{ form.firstname.label }} *</label>
                {{ form.firstname }}
            </div>
            
            <div class="form-group">
                {{ form.middle_initial.errors }}
                <label for="{{ form.middle_initial.id_for_label }}">{{ form.middle_initial.label }}</label>
                {{ form.middle_initial }}
            </div>
            
            <div class="form-group">
                {{ form.rank.errors }}
                <label for="{{ form.rank.id_for_label }}">{{ form.rank.label }} *</label>
                {{ form.rank }}
            </div>
            
            <div class="form-group">
                {{ form.serial.errors }}
                <label for="{{ form.serial.id_for_label }}">{{ form.serial.label }} *</label>
                {{ form.serial }}
                {% if form.serial.help_text %}
                <p class="help-text">{{ form.serial.help_text }}</p>
                {% endif %}
            </div>
            
            <div class="form-group">
                {{ form.office.errors }}
                <label for="{{ form.office.id_for_label }}">{{ form.office.label }} *</label>
                {{ form.office }}
            </div>
            
            <div class="form-group">
                {{ form.tel.errors }}
                <label for="{{ form.tel.id_for_label }}">{{ form.tel.label }} *</label>
                {{ form.tel }}
                {% if form.tel.help_text %}
                <p class="help-text">{{ form.tel.help_text }}</p>
                {% endif %}
            </div>
            
            <div class="form-group">
                {{ form.picture.errors }}
                <label for="{{ form.picture.id_for_label }}">{{ form.picture.label }}</label>
                {{ form.picture }}
                {% if is_edit and personnel and personnel.picture %}
                <p class="help-text">Current: {{ personnel.picture.name }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn">{% if is_edit %}Update User{% else %}Register User{% endif %}</button>
            <a href="{% url 'custom_admin:user_management' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('{{ form.role.id_for_label }}');
    const accountSection = document.getElementById('accountSection');
    const usernameGroup = document.getElementById('usernameGroup');
    const emailGroup = document.getElementById('emailGroup');
    const passwordGroup = document.getElementById('passwordGroup');
    const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
    const roleNotice = document.getElementById('roleNotice');
    const roleNoticeText = document.getElementById('roleNoticeText');
    const submitBtn = document.getElementById('submitBtn');
    const usernameInput = document.getElementById('{{ form.username.id_for_label }}');
    const emailInput = document.getElementById('{{ form.email.id_for_label }}');
    const passwordInput = document.getElementById('{{ form.password.id_for_label }}');
    const confirmPasswordInput = document.getElementById('{{ form.confirm_password.id_for_label }}');
    const isEdit = document.querySelector('.form-container').dataset.isEdit === 'true';
    
    function updateFormFields() {
        const role = roleSelect.value;
        
        if (role === 'personnel') {
            // Hide entire account section for personnel
            accountSection.classList.add('hidden');
            
            // Remove required attribute
            usernameInput.removeAttribute('required');
            emailInput.removeAttribute('required');
            passwordInput.removeAttribute('required');
            confirmPasswordInput.removeAttribute('required');
            
            // Clear values only if not editing
            if (!isEdit) {
                usernameInput.value = '';
                emailInput.value = '';
                passwordInput.value = '';
                confirmPasswordInput.value = '';
            }
            
            // Show notice
            roleNotice.classList.remove('hidden');
            roleNoticeText.textContent = 'Personnel: No login credentials needed. Only personnel profile will be created.';
            submitBtn.textContent = isEdit ? 'Update Personnel' : 'Register Personnel';
        } else if (role === 'admin') {
            // Show all fields for admin
            accountSection.classList.remove('hidden');
            usernameGroup.classList.remove('hidden');
            emailGroup.classList.remove('hidden');
            passwordGroup.classList.remove('hidden');
            confirmPasswordGroup.classList.remove('hidden');
            
            // Add required attribute (but not for password in edit mode)
            usernameInput.setAttribute('required', 'required');
            emailInput.setAttribute('required', 'required');
            if (!isEdit) {
                passwordInput.setAttribute('required', 'required');
                confirmPasswordInput.setAttribute('required', 'required');
            }
            
            // Show notice
            roleNotice.classList.remove('hidden');
            roleNoticeText.textContent = 'Admin: Full access to admin panel and system management.';
            submitBtn.textContent = isEdit ? 'Update Admin' : 'Register Admin';
        } else if (role === 'armorer') {
            // Show all fields for armorer
            accountSection.classList.remove('hidden');
            usernameGroup.classList.remove('hidden');
            emailGroup.classList.remove('hidden');
            passwordGroup.classList.remove('hidden');
            confirmPasswordGroup.classList.remove('hidden');
            
            // Add required attribute (but not for password in edit mode)
            usernameInput.setAttribute('required', 'required');
            emailInput.setAttribute('required', 'required');
            if (!isEdit) {
                passwordInput.setAttribute('required', 'required');
                confirmPasswordInput.setAttribute('required', 'required');
            }
            
            // Show notice
            roleNotice.classList.remove('hidden');
            roleNoticeText.textContent = 'Armorer: Access to inventory and transaction management.';
            submitBtn.textContent = isEdit ? 'Update Armorer' : 'Register Armorer';
        } else {
            // Default state
            roleNotice.classList.add('hidden');
            submitBtn.textContent = isEdit ? 'Update User' : 'Register User';
        }
    }
    
    // Run on page load
    updateFormFields();
    
    // Run when role changes
    roleSelect.addEventListener('change', updateFormFields);
});
</script>
{% endblock %}
