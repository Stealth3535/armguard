{% extends 'base.html' %}
{% load static %}

{% block title %}Personnel Directory - ArmGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'personnel/personnel_profile_list.css' %}?v={{ timestamp }}">
<style>
    .view-btn {
        padding: 0.25rem 0.75rem;
        background: #007bff;
        color: white;
        border-radius: 0.25rem;
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.3s;
    }
    
    .view-btn:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }
    
    .user-linked {
        color: #00b894;
    }
    
    .user-unlinked {
        color: #e17055;
    }
    
    /* Force consistent ACTIVE badge styling - highest specificity */
    .personnel-card .badge-active,
    .personnel-card span.badge.badge-active,
    .badge.badge-active,
    span.badge-active,
    .badge:contains("ACTIVE"),
    span[class*="badge"]:contains("ACTIVE") {
        background-color: #d4edda !important;
        color: #155724 !important;
        border: none !important;
    }
    
    /* Override any Bootstrap or framework badge styles */
    .badge,
    .badge-secondary,
    .badge-danger,
    .badge-primary {
        background-color: inherit;
        color: inherit;
    }
    
    /* Specific override for active status */
    .badge-active {
        background-color: #d4edda !important;
        color: #155724 !important;
    }
    
    /* Debug styling to see what's happening */
    .personnel-card .badge {
        border: 1px solid #000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Personnel Directory</h1>
            <p class="page-subtitle">{{ total_count }} Personnel Records</p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <form method="get" style="display: flex; gap: 1rem; align-items: center;">
            {{ search_form.search_query }}
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Search
            </button>
            <a href="{% url 'personnel:personnel_profile_list' %}" class="btn btn-outline-secondary">
                Clear
            </a>
        </form>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <form method="get" style="display: flex; gap: 1rem; align-items: center;">
            {{ search_form.status }}
            {{ search_form.rank_type }}
            {{ search_form.office }}
            <button type="submit" class="btn btn-secondary">Filter</button>
        </form>
    </div>
        <div class="form-group" style="margin: 0; min-width: 200px;">
            <select id="officeFilter" class="form-control form-select">
                <option value="">All Offices</option>
                <option value="HAS">HAS</option>
                <option value="951">951</option>
                <option value="952">952</option>
                <option value="953">953</option>
            </select>
        </div>
    </div>

    <!-- Personnel Cards Grid -->
    <div class="grid grid-3" id="personnelGrid">
        {% for person in page_obj %}
        <div class="card personnel-card" 
             data-status="{{ person.status }}" 
             data-rank="{% if person.is_officer %}officer{% else %}enlisted{% endif %}"
             data-office="{{ person.office }}"
             data-search="{{ person.get_full_name|lower }} {{ person.rank|lower }} {{ person.serial|lower }} {{ person.office|lower }}">
            
            <div class="d-flex gap-2 mb-2">
                {% if person.picture %}
                <img src="{{ person.picture.url }}" alt="{{ person.get_full_name }}" class="personnel-picture" style="width: 100px; height: 100px;">
                {% else %}
                <div class="no-picture" style="width: 100px; height: 100px; font-size: 0.8rem;">No Photo</div>
                {% endif %}
                
                <div style="flex: 1;">
                    <h3 style="margin: 0; color: var(--primary-color); font-size: 1.1rem;">
                        {{ person.get_full_name }}
                    </h3>
                    <p style="margin: 0.5rem 0; color: var(--text-light);">
                        <strong>{{ person.rank }}</strong>
                    </p>
                    <div>
                        {% if person.is_officer %}
                        <span class="badge badge-officer">Officer</span>
                        {% else %}
                        <span class="badge badge-enlisted">Enlisted</span>
                        {% endif %}
                        
                        {% if person.status == 'Active' %}
                        <span class="badge badge-active">{{ person.status }}</span>
                        {% elif person.status == 'ACTIVE' %}
                        <span class="badge badge-active">{{ person.status }}</span>
                        {% else %}
                        <span class="badge badge-inactive">{{ person.status }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="detail-grid" style="margin-top: 1rem;">
                <div class="detail-item" style="padding: 0.5rem;">
                    <div class="detail-label" style="font-size: 0.75rem;">ID</div>
                    <div class="detail-value" style="font-size: 0.9rem;">{{ person.id }}</div>
                </div>
                <div class="detail-item" style="padding: 0.5rem;">
                    <div class="detail-label" style="font-size: 0.75rem;">Serial</div>
                    <div class="detail-value" style="font-size: 0.9rem;">{{ person.serial }}</div>
                </div>
                <div class="detail-item" style="padding: 0.5rem;">
                    <div class="detail-label" style="font-size: 0.75rem;">Office</div>
                    <div class="detail-value" style="font-size: 0.9rem;">{{ person.office }}</div>
                </div>
                <div class="detail-item" style="padding: 0.5rem;">
                    <div class="detail-label" style="font-size: 0.75rem;">Phone</div>
                    <div class="detail-value" style="font-size: 0.9rem;">{{ person.tel }}</div>
                </div>
            </div>
            
            <div class="mt-2">
                <a href="{% url 'personnel:personnel_profile_detail' person.id %}" class="btn btn-primary btn-sm" style="width: 100%;">View Details â†’</a>
                
                {% if user.is_superuser or 'Admin' in user.groups.all|join:',' %}
                <div style="margin-top: 0.5rem;">
                    <small class="text-muted" style="font-size: 0.7rem; display: block; text-align: center;">
                        To edit or register personnel, use the 
                        <a href="{% url 'armguard_admin:registration' %}" class="text-primary">Registration Form</a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h4 class="text-muted mb-2">No Personnel Found</h4>
            <p class="text-muted mb-3">
                {% if request.GET.search_query %}
                    No personnel match your search criteria.
                {% else %}
                    No personnel records have been created yet.
                {% endif %}
            </p>
            {% if user.is_superuser or 'Admin' in user.groups.all|join:',' %}
            <a href="{% url 'armguard_admin:registration' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Register Personnel
            </a>
            <br>
            <small class="text-muted mt-2" style="display: block;">
                Use the Registration Form to add new personnel
            </small>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Force all ACTIVE badges to have consistent styling
    const allBadges = document.querySelectorAll('.badge');
    allBadges.forEach(function(badge) {
        if (badge.textContent.trim() === 'ACTIVE' || badge.textContent.trim() === 'Active') {
            badge.style.setProperty('background-color', '#d4edda', 'important');
            badge.style.setProperty('color', '#155724', 'important');
            badge.style.setProperty('border', 'none', 'important');
            console.log('Fixed badge:', badge.textContent, badge);
        }
    });
});
</script>
{% endblock %}
